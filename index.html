<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>空投助手</title>
    <style>
        :root {
            /* === 全局配色 === */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --primary-text: #1f2937;
            --secondary-text: #9ca3af;
            --accent-color: #ff6b6b; /* 强调红 */
            --wear-color: #059669;   /* 绿色 */
            --btn-hover: #fa5252;
            --radius: 16px;
            
            /* 阴影 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            /* 禁止iOS点击高亮 */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--primary-text);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px 16px; /* 适配手机边距 */
        }

        .container {
            width: 100%;
            max-width: 500px; /* 限制最大宽度适配手机 */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* === 顶部 Tabs === */
        .tabs-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }

        .tabs {
            background: #e5e7eb;
            padding: 4px;
            border-radius: 12px;
            display: flex;
            gap: 4px;
        }

        .tab-btn {
            padding: 8px 14px; 
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background-color: var(--card-bg);
            color: var(--primary-text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* === 页面显隐控制 === */
        .tool-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tool-section.active {
            display: flex; 
            flex-direction: column;
            gap: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           新版磨损计算样式 (Formula Style)
           ========================================= */
        .formula-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .formula-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .formula-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-text);
            margin-bottom: 4px;
        }

        /* 弹性行布局 */
        .formula-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* 数学符号 */
        .math-symbol {
            font-size: 18px;
            font-weight: bold;
            color: #d1d5db;
            flex-shrink: 0; /* 防止符号被压缩 */
        }
        
        .static-num {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text);
            background: #f3f4f6;
            padding: 12px 8px;
            border-radius: 8px;
            white-space: nowrap;
        }

        /* 输入框样式 */
        .math-input {
            width: 100%;
            flex: 1; /* 自动填充剩余空间 */
            padding: 12px 5px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid #f3f4f6;
            border-radius: 10px;
            background-color: #f9fafb;
            color: var(--primary-text);
            outline: none;
            transition: all 0.2s;
            min-width: 60px; /* 防止过小 */
        }

        .math-input:focus {
            border-color: var(--accent-color);
            background: #fff;
        }
        
        .math-input::placeholder {
            color: #e5e7eb;
            font-weight: 400;
            font-size: 14px;
        }

        /* 结果样式 */
        .math-result {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent-color);
            min-width: 60px;
            text-align: right;
            white-space: nowrap;
        }
        
        .math-result.placeholder {
            color: #e5e7eb;
        }

        /* =========================================
           其他旧有样式保留 (记账、倒计时)
           ========================================= */
        /* 记账统计卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 16px 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }
        .stat-label { font-size: 12px; color: var(--secondary-text); margin-bottom: 6px; }
        .stat-value { font-size: 18px; font-weight: 700; color: var(--accent-color); display: flex; flex-direction: column; align-items: center; line-height: 1.2;}
        .stat-sub { font-size: 10px; color: var(--secondary-text); margin-top: 2px; opacity: 0.8; font-weight: normal;}
        .stat-card.wear .stat-value { color: var(--wear-color); } 
        .stat-card.profit .stat-value { color: var(--primary-text); }

        /* 日历 */
        .calendar-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px; 
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: center;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            width: 100%;
        }
        .day-cell {
            aspect-ratio: 1;
            border-radius: 10px; 
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            cursor: pointer;
            border: 2px solid transparent;
        }
        .day-cell.has-data { border-color: var(--accent-color); background-color: #fff1f2; }
        .day-number { font-size: 16px; font-weight: 700; color: var(--primary-text); }
        .day-indicator { font-size: 9px; margin-top: 2px; display: none; }
        .day-cell.has-data .day-indicator { display: block; }
        .positive-profit { color: var(--accent-color); } 
        .negative-profit { color: var(--wear-color); }
        
        .reset-btn-container { display: flex; justify-content: center; margin-top: 10px; }
        .reset-btn { font-size: 13px; color: var(--secondary-text); background: none; border: 1px solid #e5e7eb; padding: 8px 20px; border-radius: 8px; width: 100%; }

        /* 倒计时样式复用 */
        .time-tool-wrapper {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px 20px;
            box-shadow: var(--shadow-md);
        }
        .tool-header h2 { margin: 0 0 20px 0; text-align: center; font-size: 18px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; color: var(--secondary-text); margin-bottom: 6px; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .time-tool-input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; font-size: 16px; outline: none; }
        .time-tool-input:focus { border-color: var(--accent-color); background: #fff; }
        .result-box { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e5e7eb; text-align: center; }
        .time-text { font-size: 24px; font-weight: 700; color: var(--accent-color); font-family: monospace; }
        .error-msg { color: var(--accent-color); font-size: 13px; margin-top: 5px; display: none; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 1000;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal {
            background: var(--card-bg); padding: 25px; border-radius: 20px;
            width: 85%; max-width: 320px; box-shadow: var(--shadow-lg);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal h3 { text-align: center; margin-bottom: 15px; font-size: 18px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 14px; color: var(--secondary-text); }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 16px; background: #f9fafb; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; }
        .btn-cancel { background: #f3f4f6; color: var(--primary-text); }
        .btn-save { background: var(--accent-color); color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs-wrapper">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('revenue', this)">记账面板</button>
            <button class="tab-btn" onclick="switchTab('wear', this)">磨损公式</button>
            <button class="tab-btn" onclick="switchTab('time', this)">空投倒计时</button>
        </div>
    </div>

    <div id="section-revenue" class="tool-section active">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">总收入</div>
                <div class="stat-value" id="total-revenue">$0</div>
            </div>
            <div class="stat-card wear">
                <div class="stat-label">总磨损</div>
                <div class="stat-value" id="total-wear">$0</div>
            </div>
            <div class="stat-card profit">
                <div class="stat-label">净利润</div>
                <div class="stat-value" id="total-profit">$0</div>
            </div>
        </div>

        <div class="calendar-section">
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        
        <div class="reset-btn-container">
            <button class="reset-btn" onclick="clearAllData()">重置数据</button>
        </div>
    </div>

    <div id="section-wear" class="tool-section">
        <div class="formula-card">
            
            <div class="formula-group">
                <div class="formula-title">磨损计算</div>
                <div class="formula-row">
                    <input type="number" id="f1-a" class="math-input" placeholder="数A" step="0.01">
                    <span class="math-symbol">-</span>
                    <input type="number" id="f1-b" class="math-input" placeholder="数B" step="0.01">
                    <span class="math-symbol">=</span>
                    <div id="f1-result" class="math-result placeholder">?</div>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px dashed #e5e7eb;">

            <div class="formula-group">
                <div class="formula-title">刷分公式</div>
                <div class="formula-row">
                    <span class="math-symbol">(</span>
                    <div class="static-num">32768</div>
                    <span class="math-symbol">-</span>
                    <input type="number" id="f2-a" class="math-input" placeholder="输入" step="1">
                    <span class="math-symbol">)</span>
                </div>
                <div class="formula-row" style="justify-content: flex-end;">
                    <span class="math-symbol">÷</span>
                    <div class="static-num">4</div>
                    <span class="math-symbol">=</span>
                    <div id="f2-result" class="math-result placeholder">?</div>
                </div>
            </div>

        </div>
    </div>

    <div id="section-time" class="tool-section">
        <div class="time-tool-wrapper">
            <div class="tool-header">
                <h2>空投时间计算器</h2>
            </div>
            
            <div class="input-group">
                <label>当前积分</label>
                <div class="input-wrapper">
                    <input type="number" id="currentScore" class="time-tool-input" placeholder="请输入当前积分">
                </div>
            </div>

            <div class="input-group">
                <label>空投门槛 </label>
                <div class="input-wrapper">
                    <input type="number" id="startThreshold" class="time-tool-input" placeholder="请输入积分门槛">
                </div>
            </div>

            <div class="input-group">
                <label>空投开始时间</label>
                <div class="input-wrapper">
                    <input type="time" id="startTime" class="time-tool-input">
                </div>
            </div>

            <div class="result-box">
                <div id="resultText" class="result-text">
                    <span class="time-text" style="color:#d1d5db">--:--</span> <span style="font-size:14px">可抢</span>
                </div>
                <div id="errorMsg" class="error-msg"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <h3 id="modal-title">记账录入</h3>
        <div class="form-group">
            <label>收入 ($)</label>
            <input type="number" id="input-revenue" placeholder="0.00" step="0.01">
        </div>
        <div class="form-group">
            <label>磨损 ($)</label>
            <input type="number" id="input-wear" placeholder="0.00" step="0.01">
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal()">取消</button>
            <button class="btn btn-save" onclick="saveData()">确认</button>
        </div>
    </div>
</div>

<script>
    /* =========================================
       全局：Tab 切换
       ========================================= */
    function switchTab(tabName, clickedButton) {
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        if(clickedButton) clickedButton.classList.add('active');

        const sections = document.querySelectorAll('.tool-section');
        sections.forEach(sec => sec.classList.remove('active'));
        
        const target = document.getElementById(`section-${tabName}`);
        if(target) target.classList.add('active');
    }

    /* =========================================
       逻辑 1: 记账面板
       ========================================= */
    const LEDGER_STORAGE_KEY = 'my_accounting_app_v1';
    const DEFAULT_WEAR = '1.7'; 
    let ledgerData = {};
    let currentSelectedDate = null;
    let exchangeRate = 7.30; 

    function initRevenueTool() {
        loadDataFromStorage();
        initCalendar();
        fetchExchangeRate();
        updateRevenueUI(); 
    }

    async function fetchExchangeRate() {
        try {
            const response = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await response.json();
            if (data && data.rates && data.rates.CNY) {
                exchangeRate = data.rates.CNY;
                updateRevenueUI();
            }
        } catch (e) { console.log("Exchange rate fetch failed"); }
    }

    function loadDataFromStorage() {
        const saved = localStorage.getItem(LEDGER_STORAGE_KEY);
        if (saved) { try { ledgerData = JSON.parse(saved); } catch (e) { ledgerData = {}; } }
    }
    
    function saveLedgerData() {
        localStorage.setItem(LEDGER_STORAGE_KEY, JSON.stringify(ledgerData));
    }

    function initCalendar() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        const daysInMonth = 31; 
        for (let i = 1; i <= daysInMonth; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';
            dayCell.dataset.date = i;
            dayCell.onclick = () => openModal(i);
            dayCell.innerHTML = `<div class="day-number">${i}</div><div class="day-indicator"></div>`;
            grid.appendChild(dayCell);
        }
    }

    function openModal(date) {
        currentSelectedDate = date;
        const data = ledgerData[date];
        document.getElementById('input-revenue').value = data ? data.revenue : '';
        document.getElementById('input-wear').value = data ? data.wear : DEFAULT_WEAR;
        document.getElementById('modal-overlay').classList.add('open');
        setTimeout(() => document.getElementById('input-revenue').focus(), 100);
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.remove('open');
        currentSelectedDate = null;
    }

    function saveData() {
        if (!currentSelectedDate) return;
        const rev = parseFloat(document.getElementById('input-revenue').value);
        const wear = parseFloat(document.getElementById('input-wear').value);
        
        if ((isNaN(rev) && isNaN(wear)) || (document.getElementById('input-revenue').value==='' && document.getElementById('input-wear').value==='')) {
            delete ledgerData[currentSelectedDate];
        } else {
            ledgerData[currentSelectedDate] = { revenue: isNaN(rev) ? 0 : rev, wear: isNaN(wear) ? 0 : wear };
        }
        saveLedgerData(); 
        updateRevenueUI();
        closeModal();
    }

    function updateRevenueUI() {
        let totalRev = 0, totalWear = 0;
        for (let date in ledgerData) {
            totalRev += ledgerData[date].revenue;
            totalWear += ledgerData[date].wear;
        }
        const profit = totalRev - totalWear;

        const formatMoney = (usd) => {
            const cleanUsd = parseFloat(usd.toFixed(2));
            const cny = (cleanUsd * exchangeRate).toFixed(2);
            return `<span>$${cleanUsd.toLocaleString('en-US', {minimumFractionDigits: 2})}</span><span class="stat-sub">≈ ¥${parseFloat(cny).toLocaleString('zh-CN')}</span>`;
        };

        document.getElementById('total-revenue').innerHTML = formatMoney(totalRev);
        document.getElementById('total-wear').innerHTML = formatMoney(totalWear);
        document.getElementById('total-profit').innerHTML = formatMoney(profit);

        document.querySelectorAll('.day-cell').forEach(cell => {
            const d = cell.dataset.date;
            const indicator = cell.querySelector('.day-indicator');
            cell.classList.remove('has-data');
            indicator.innerHTML = '';
            
            if (ledgerData[d]) {
                cell.classList.add('has-data');
                const p = ledgerData[d].revenue - ledgerData[d].wear;
                const formatted = Math.abs(p).toFixed(2);
                if (p > 0) indicator.innerHTML = `<span class="positive-profit">+${formatted}</span>`;
                else if (p < 0) indicator.innerHTML = `<span class="negative-profit">-${formatted}</span>`;
                else indicator.innerHTML = `<span style="color:#6b7280">$0</span>`;
            }
        });
    }

    function clearAllData() {
        if(confirm("确定清空？")) {
            ledgerData = {}; localStorage.removeItem(LEDGER_STORAGE_KEY); updateRevenueUI();
        }
    }

    /* =========================================
       逻辑 2: 磨损公式 (新版)
       ========================================= */
    const WEAR_CALC_KEY = 'wear_formula_data';
    const f1a = document.getElementById('f1-a');
    const f1b = document.getElementById('f1-b');
    const f1res = document.getElementById('f1-result');
    const f2a = document.getElementById('f2-a');
    const f2res = document.getElementById('f2-result');

    function loadWearData() {
        const saved = localStorage.getItem(WEAR_CALC_KEY);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                f1a.value = data.f1a || '';
                f1b.value = data.f1b || '';
                f2a.value = data.f2a || '';
                calcF1(); calcF2();
            } catch(e){}
        }
    }

    function saveWearData() {
        localStorage.setItem(WEAR_CALC_KEY, JSON.stringify({
            f1a: f1a.value, f1b: f1b.value, f2a: f2a.value
        }));
    }

    function calcF1() {
        const v1 = parseFloat(f1a.value);
        const v2 = parseFloat(f1b.value);
        if(!isNaN(v1) && !isNaN(v2)) {
            f1res.textContent = (v1 - v2).toFixed(2);
            f1res.classList.remove('placeholder');
        } else {
            f1res.textContent = "?";
            f1res.classList.add('placeholder');
        }
        saveWearData();
    }

    function calcF2() {
        const v = parseFloat(f2a.value);
        if(!isNaN(v)) {
            const res = (32768 - v) / 4;
            f2res.textContent = res % 1 === 0 ? res : res.toFixed(2);
            f2res.classList.remove('placeholder');
        } else {
            f2res.textContent = "?";
            f2res.classList.add('placeholder');
        }
        saveWearData();
    }

    f1a.addEventListener('input', calcF1);
    f1b.addEventListener('input', calcF1);
    f2a.addEventListener('input', calcF2);

    /* =========================================
       逻辑 3: 倒计时
       ========================================= */
    const TIME_KEY = 'airdrop_time_data'; 
    const cScore = document.getElementById('currentScore');
    const sThreshold = document.getElementById('startThreshold');
    const sTime = document.getElementById('startTime');
    const rText = document.getElementById('resultText');
    const eMsg = document.getElementById('errorMsg');

    function loadTimeData() {
        const saved = localStorage.getItem(TIME_KEY);
        if (saved) {
            const d = JSON.parse(saved);
            cScore.value = d.score || ''; sThreshold.value = d.threshold || ''; sTime.value = d.time || '';
            calcTime();
        }
    }

    function calcTime() {
        localStorage.setItem(TIME_KEY, JSON.stringify({score:cScore.value, threshold:sThreshold.value, time:sTime.value}));
        
        const sc = parseInt(cScore.value);
        const th = parseInt(sThreshold.value);
        const tm = sTime.value;

        if(!sc || !th || !tm) {
            rText.innerHTML = `<span class="time-text" style="color:#d1d5db">--:--</span> <span style="font-size:14px">可抢</span>`;
            eMsg.style.display = 'none'; return;
        }

        if (sc < 70) {
            eMsg.style.display = 'block'; eMsg.innerText = '积分低于70不可参与';
            rText.innerHTML = '<span style="color:#aaa">--:--</span>'; return;
        }
        eMsg.style.display = 'none';

        const [h, m] = tm.split(':').map(Number);
        const d = new Date(); d.setHours(h); d.setMinutes(m);
        
        if (sc < th) {
            const diff = Math.ceil((th - sc) / 5) * 5;
            d.setMinutes(d.getMinutes() + diff);
        }

        const rs = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
        rText.innerHTML = `<span class="time-text">${rs}</span> <span style="font-size:14px">可抢</span>`;
    }

    cScore.oninput = calcTime; sThreshold.oninput = calcTime; sTime.oninput = calcTime;

    // 初始化
    initRevenueTool();
    loadWearData();
    loadTimeData();

</script>
</body>
</html>